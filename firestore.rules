rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Matches polls structure
    match /matches/{matchId}/polls/{pollId} {
      // Public read for polls (adjust if you want to restrict visibility)
      allow read: if true;

      // Allow any authenticated user to create a poll. For update/delete,
      // allow only the creator (createdBy) or an admin.
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.createdBy == request.auth.uid;

      // Votes subcollection
      match /votes/{userId} {
        // Reading votes allowed (for displaying results). If you want results only aggregated server-side, restrict this.
        allow read: if true;

        // Allow a user to create/update their own vote document only
        allow create, update: if request.auth != null && request.auth.uid == userId;

        // Only admins can delete other users' votes
        allow delete: if request.auth != null && isAdmin(request.auth.uid);
      }
    }

    // Admins collection check helper (document existence)
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/admins/$(uid));
    }
  }
}
